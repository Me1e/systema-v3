name: Deploy

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-main
      cancel-in-progress: false
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.HETZNER_SSH_KEY }}
      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts
      - name: Sync repo to server
        run: |
          rsync -az \
            --delete \
            --exclude node_modules \
            --exclude .next \
            --exclude .git \
            --exclude ".env" \
            ./ ${{ secrets.USER }}@${{ secrets.HOST }}:${{ secrets.REMOTE_PATH }}
      - name: Compose up
        run: |
          ssh ${{ secrets.USER }}@${{ secrets.HOST }} "set -euo pipefail; cd ${{ secrets.REMOTE_PATH }}; ENV_FILE=\".env\"; if [ ! -f \"$ENV_FILE\" ]; then for CAND in .env ../.env \$HOME/.env \$HOME/systema-v3/.env /opt/systema-v3/.env; do if [ -f \"$CAND\" ]; then ENV_FILE=\"$CAND\"; break; fi; done; fi; if [ ! -f \"$ENV_FILE\" ]; then echo 'ERROR: .env not found on server'; exit 1; fi; ln -sf \"$ENV_FILE\" .env; echo Using env file: \"$ENV_FILE\"; docker compose --env-file \"$ENV_FILE\" -f deploy/docker-compose.yml up -d --build"
